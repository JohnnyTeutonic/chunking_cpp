#!/bin/bash
# Default settings
PREFIX=/usr/local
BUILD_TYPE=Release
ENABLE_TESTS=1
ENABLE_DOCS=1
# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color
# Print help message
print_help() {
    echo "Configure script for Advanced Chunk Processing Library"
    echo
    echo "Usage: ./configure [options]"
    echo
    echo "Options:"
    echo "  --prefix=PATH        Installation prefix [$PREFIX]"
    echo "  --build-type=TYPE    Build type (Debug|Release) [$BUILD_TYPE]"
    echo "  --disable-tests      Disable building tests"
    echo "  --disable-docs       Disable building documentation"
    echo "  --help              Display this help message"
    echo
}

# Parse command line arguments
for arg in "$@"; do
    case "$arg" in
        --prefix=*)
            PREFIX="${arg#*=}"
            ;;
        --build-type=*)
            BUILD_TYPE="${arg#*=}"
            ;;
        --disable-tests)
            ENABLE_TESTS=0
            ;;
        --disable-docs)
            ENABLE_DOCS=0
            ;;
        --help)
            print_help
            exit 0
            ;;
        *)
            echo "Unknown option: $arg"
            print_help
            exit 1
            ;;
    esac
done

# Check for required programs
check_program() {
    if ! command -v "$1" &> /dev/null; then
        echo -e "${RED}Error: $1 not found${NC}"
        echo "Please install $1 and try again"
        exit 1
    fi
    echo -e "${GREEN}Found $1:${NC} $(command -v "$1")"
}

echo "Checking for required programs..."
check_program g++
check_program make

# Check C++ compiler version
CXX_VERSION=$(g++ --version | head -n1)
echo -e "${GREEN}C++ compiler version:${NC} $CXX_VERSION"

# Check for optional dependencies
if [ $ENABLE_TESTS -eq 1 ]; then
    echo "Checking for testing dependencies..."
    if ! g++ -lgtest -lgtest_main 2>/dev/null; then
        echo -e "${YELLOW}Warning: Google Test not found${NC}"
        echo "Tests will not be built"
        ENABLE_TESTS=0
    else
        echo -e "${GREEN}Found Google Test${NC}"
    fi
fi

if [ $ENABLE_DOCS -eq 1 ]; then
    echo "Checking for documentation dependencies..."
    check_program doxygen
    check_program dot
fi

# Create config.mk
echo "Creating config.mk..."
cat > config.mk << EOF
# Generated by configure script - do not edit

PREFIX = $PREFIX
BUILD_TYPE = $BUILD_TYPE
ENABLE_TESTS = $ENABLE_TESTS
ENABLE_DOCS = $ENABLE_DOCS

# Compiler flags
ifeq (\$(BUILD_TYPE),Debug)
    CXXFLAGS += -g -O0 -DDEBUG
else
    CXXFLAGS += -O2 -DNDEBUG
endif

# Installation paths
bindir = \$(PREFIX)/bin
libdir = \$(PREFIX)/lib
includedir = \$(PREFIX)/include
docdir = \$(PREFIX)/share/doc/chunker

# Dependencies
HAVE_GTEST = $ENABLE_TESTS
HAVE_DOXYGEN = $ENABLE_DOCS
EOF

# Create build directory
echo "Creating build directory..."
mkdir -p build

echo -e "\n${GREEN}Configuration complete!${NC}"
echo
echo "Build settings:"
echo "  Prefix:      $PREFIX"
echo "  Build type:  $BUILD_TYPE"
echo "  Tests:       $([ $ENABLE_TESTS -eq 1 ] && echo "enabled" || echo "disabled")"
echo "  Docs:        $([ $ENABLE_DOCS -eq 1 ] && echo "enabled" || echo "disabled")"
echo
echo "To build the project, run:"
echo "  make"
echo
echo "To install, run:"
echo "  make install"
</rewritten_file> 